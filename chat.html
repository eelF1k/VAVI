# chat_server.py
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from typing import Dict, List
import uvicorn
import db
import asyncio
import json
from datetime import datetime

app = FastAPI()

@app.on_event("startup")
async def startup_event():
    await db.init_db()

class ConnectionManager:
    def __init__(self):
        self.active_connections: Dict[int, WebSocket] = {}

    async def connect(self, websocket: WebSocket, user_id: int):
        await websocket.accept()
        self.active_connections[user_id] = websocket
        print(f"Користувач {user_id} підключився.")

    def disconnect(self, user_id: int):
        if user_id in self.active_connections:
            del self.active_connections[user_id]
            print(f"Користувач {user_id} від'єднався.")

    async def broadcast(self, message: str):
        for connection in self.active_connections.values():
            await connection.send_text(message)

manager = ConnectionManager()

@app.websocket("/ws/{user_id}")
async def websocket_endpoint(websocket: WebSocket, user_id: int):
    await manager.connect(websocket, user_id)
    
    # Крок 1: Завантажуємо та відправляємо історію чату при підключенні
    try:
        history = await db.get_chat_history(user_id)
        for msg in history:
            # Надсилаємо кожне історичне повідомлення у форматі JSON
            await websocket.send_text(json.dumps(dict(msg)))
    except Exception as e:
        print(f"Помилка завантаження історії для {user_id}: {e}")

    # Крок 2: Слухаємо нові повідомлення
    try:
        while True:
            data = await websocket.receive_text()
            
            # Зберігаємо нове повідомлення в БД
            await db.save_chat_message(user_id, 'user', data)
            
            # Створюємо об'єкт повідомлення для відправки всім
            message_obj = {
                "message_id": None, # ID буде з бази, але для миттєвої відправки він не потрібен
                "user_id": user_id,
                "sender_type": "user",
                "message_text": data,
                "timestamp": datetime.now().isoformat()
            }
            
            # Розсилаємо нове повідомлення всім підключеним
            await manager.broadcast(json.dumps(message_obj))
            
    except WebSocketDisconnect:
        manager.disconnect(user_id)
    except Exception as e:
        print(f"Сталася помилка з користувачем {user_id}: {e}")
        manager.disconnect(user_id)

if __name__ == "__main__":
    uvicorn.run(app, host="0.0.0.0", port=8000)
