<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Chat</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body, html { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; height: 100vh; overflow: hidden; }
        body { color: var(--tg-theme-text-color); background-color: var(--tg-theme-bg-color); display: flex; flex-direction: column; }
        #messages { list-style-type: none; padding: 10px; margin: 0; flex-grow: 1; overflow-y: auto; }
        #messages li { padding: 8px 12px; margin-bottom: 8px; border-radius: 18px; max-width: 70%; word-wrap: break-word; }
        .user { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); margin-left: auto; border-bottom-right-radius: 4px; }
        .admin { background-color: var(--tg-theme-secondary-bg-color); margin-right: auto; border-bottom-left-radius: 4px; }
        #form { display: flex; padding: 10px; border-top: 1px solid var(--tg-theme-hint-color); }
        #messageText { flex-grow: 1; padding: 10px; border: 1px solid var(--tg-theme-hint-color); border-radius: 5px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        button { padding: 10px 15px; border: none; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border-radius: 5px; margin-left: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <ul id="messages"></ul>
    <form id="form" onsubmit="sendMessage(event)">
        <input type="text" id="messageText" autocomplete="off" placeholder="Ваше повідомлення..." disabled/>
        <button type="submit" disabled>Надіслати</button>
    </form>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();

    // Отримуємо дані користувача з Telegram. Це найважливіша частина.
    const user = tg.initDataUnsafe.user;
    let ws; // Оголошуємо змінну WebSocket тут

    // Перевіряємо, чи вдалося отримати дані користувача
    if (!user) {
        console.error("Не вдалося отримати дані користувача. Додаток має бути запущений в Telegram.");
        // Блокуємо форму, якщо дані недоступні
        document.getElementById('messageText').disabled = true;
        document.querySelector('#form button').disabled = true;
        document.getElementById('messageText').placeholder = "Помилка: запустіть через Telegram";
    } else {
        // Створюємо WebSocket з'єднання, тільки якщо є дані користувача
        ws = new WebSocket('wss://briefly-picked-vbulletin-greece.trycloudflare.com');

        // Спрацює, коли з'єднання буде успішно встановлено
        ws.onopen = function() {
            console.log("WebSocket з'єднання встановлено.");

            // 1. НАЙВАЖЛИВІШЕ: "Представляємося" серверу, надсилаючи ID користувача
            ws.send(JSON.stringify({
                action: "init",
                user_id: user.id
            }));

            // 2. Тепер просимо історію чату (сервер вже знає, для кого)
            ws.send(JSON.stringify({
                action: "get_history"
            }));

            // 3. ЯВНО ВМИКАЄМО ПОЛЕ ВВОДУ, оскільки з'єднання стабільне
            document.getElementById('messageText').disabled = false;
            document.querySelector('#form button').disabled = false;
            document.getElementById('messageText').focus(); // Ставимо курсор у поле вводу
        };

        // Спрацює при отриманні повідомлення від сервера
        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                if (data.type === 'history') {
                    // Очищуємо старі повідомлення і додаємо історію
                    const messages = document.getElementById("messages");
                    messages.innerHTML = '';
                    data.messages.forEach(msg => addMessage(msg.sender_type, msg.message_text));
                } else if (data.type === 'message') {
                    // Додаємо нове повідомлення
                    addMessage(data.sender_type, data.message_text);
                }
            } catch (e) {
                console.error("Помилка обробки даних від сервера:", event.data, e);
            }
        };

        // Спрацює, якщо з'єднання закриється
        ws.onclose = function(event) {
            console.error("WebSocket з'єднання закрито.", event);
            document.getElementById('messageText').placeholder = "Зв'язок втрачено. Перезавантажте.";
            document.getElementById('messageText').disabled = true;
            document.querySelector('#form button').disabled = true;
        };
        
        // Спрацює при помилці з'єднання
        ws.onerror = function(error) {
            console.error("Помилка WebSocket:", error);
        };
    }

    // Функція для додавання повідомлення у чат
    function addMessage(sender, text) {
        const messages = document.getElementById("messages");
        const li = document.createElement("li");
        li.textContent = text;
        li.className = (sender === 'admin') ? 'admin' : 'user';
        messages.appendChild(li);
        // Прокручуємо до останнього повідомлення
        messages.scrollTop = messages.scrollHeight;
    }

    // Функція для надсилання повідомлення
    function sendMessage(event) {
        event.preventDefault();
        const input = document.getElementById("messageText");
        
        if (input.value && ws && ws.readyState === WebSocket.OPEN) {
            // Тепер ми надсилаємо простий текст, сервер сам додасть ID
            ws.send(JSON.stringify({
                 action: "message", // Додаємо дію для ясності
                 text: input.value
            }));
            input.value = '';
        }
    }
    </script>
</body>
</html>
