<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: var(--tg-theme-text-color); background-color: var(--tg-theme-bg-color); text-align: center; }
        .container { padding: 20px; }
        #loader { font-size: 18px; }
        #welcome-screen { display: none; } /* –°—Ö–æ–≤–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        h1 { font-size: 24px; }
        p { color: var(--tg-theme-hint-color); }
        button { padding: 12px 24px; font-size: 16px; font-weight: bold; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loader" data-translate-text="loader_text">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        <div id="welcome-screen">
            <h1 data-translate-text="welcome_title">üëã –í—ñ—Ç–∞—î–º–æ –≤ —á–∞—Ç—ñ!</h1>
            <p data-translate-text="welcome_subtitle">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ä–æ–∑–º–æ–≤—É –∑ –Ω–∞—à–æ—é –∫–æ–º–∞–Ω–¥–æ—é –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.</p>
            <button id="start-chat-btn" data-translate-text="start_chat_button">–ü–æ—á–∞—Ç–∏ —á–∞—Ç</button>
        </div>
    </div>

    <script>
        const translations = {
            'ua': {
                'loader_text': '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...',
                'welcome_title': 'üëã –í—ñ—Ç–∞—î–º–æ –≤ —á–∞—Ç—ñ!',
                'welcome_subtitle': '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ä–æ–∑–º–æ–≤—É –∑ –Ω–∞—à–æ—é –∫–æ–º–∞–Ω–¥–æ—é –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.',
                'start_chat_button': '–ü–æ—á–∞—Ç–∏ —á–∞—Ç',
                'connection_error': '–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.'
            },
            'en': {
                'loader_text': 'Loading...',
                'welcome_title': 'üëã Welcome to the chat!',
                'welcome_subtitle': 'Press the button below to start a conversation with our support team.',
                'start_chat_button': 'Start Chat',
                'connection_error': 'Connection error. Please try again later.'
            },
            'ru': {
                'loader_text': '–ó–∞–≥—Ä—É–∑–∫–∞...',
                'welcome_title': 'üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç!',
                'welcome_subtitle': '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –Ω–∞—à–µ–π –∫–æ–º–∞–Ω–¥–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏.',
                'start_chat_button': '–ù–∞—á–∞—Ç—å —á–∞—Ç',
                'connection_error': '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
            }
        };

        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user_id') || 'unknown_user';
        const userLang = params.get('lang') || 'ua';
        const langDict = translations[userLang] || translations['ua'];

        const loader = document.getElementById('loader');
        const welcomeScreen = document.getElementById('welcome-screen');
        const startChatBtn = document.getElementById('start-chat-btn');

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –ø–µ—Ä–µ–∫–ª–∞–¥—ñ–≤
        function applyTranslations() {
            document.querySelectorAll('[data-translate-text]').forEach(el => {
                const key = el.getAttribute('data-translate-text');
                if (langDict[key]) el.textContent = langDict[key];
            });
        }
        
        applyTranslations();
        
        // !!! –í–ê–ñ–õ–ò–í–û !!!
        // –í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏ –ü–£–ë–õ–Ü–ß–ù–£ –∞–¥—Ä–µ—Å—É –≤–∞—à–æ–≥–æ —á–∞—Ç-—Å–µ—Ä–≤–µ—Ä–∞ (–∑ VPS –∞–±–æ Cloudflare/ngrok)
        const WEBSOCKET_URL = "wss://your-public-server-address.com"; 
        
        let ws;
        try {
            ws = new WebSocket(`${WEBSOCKET_URL}/ws/${userId}/false`);
        } catch (error) {
            loader.textContent = langDict['connection_error'];
        }
        
        ws.onopen = function() {
            ws.send(JSON.stringify({ action: 'check_user_chat' }));
        };

        ws.onmessage = function(event) {
            const response = JSON.parse(event.data);
            if (response.type === 'user_status') {
                const chatUrl = `chat.html?user_id=${userId}&lang=${userLang}`;
                if (response.exists) {
                    window.location.replace(chatUrl);
                } else {
                    loader.style.display = 'none';
                    welcomeScreen.style.display = 'block';
                }
            }
        };

        ws.onerror = function() {
            loader.textContent = langDict['connection_error'];
        };

        startChatBtn.onclick = function() {
            ws.send(JSON.stringify({ action: 'start_new_chat' }));
            // –î–∞—î–º–æ —Å–µ—Ä–≤–µ—Ä—É –º–∏—Ç—å –Ω–∞ –æ–±—Ä–æ–±–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è–º
            setTimeout(() => {
                window.location.href = `chat.html?user_id=${userId}&lang=${userLang}`;
            }, 100);
        };

    </script>
</body>
</html>
