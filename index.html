<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—ñ–¥—Ç—Ä–∏–º–∫–∞</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; color: var(--tg-theme-text-color); background-color: var(--tg-theme-bg-color); text-align: center; }
        .container { padding: 20px; }
        #loader { font-size: 18px; }
        #welcome-screen { display: none; } /* –°—Ö–æ–≤–∞–Ω–æ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        h1 { font-size: 24px; }
        p { color: var(--tg-theme-hint-color); }
        button { padding: 12px 24px; font-size: 16px; font-weight: bold; background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loader">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        <div id="welcome-screen">
            <h1>üëã –í—ñ—Ç–∞—î–º–æ –≤ —á–∞—Ç—ñ!</h1>
            <p>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∏–∂—á–µ, —â–æ–± –ø–æ—á–∞—Ç–∏ —Ä–æ–∑–º–æ–≤—É –∑ –Ω–∞—à–æ—é –∫–æ–º–∞–Ω–¥–æ—é –ø—ñ–¥—Ç—Ä–∏–º–∫–∏.</p>
            <button id="start-chat-btn">–ü–æ—á–∞—Ç–∏ —á–∞—Ç</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const params = new URLSearchParams(window.location.search);
        const userId = params.get('user_id') || 'unknown_user';
        const userLang = params.get('lang') || 'ua';

        const loader = document.getElementById('loader');
        const welcomeScreen = document.getElementById('welcome-screen');
        const startChatBtn = document.getElementById('start-chat-btn');

        // –í–∫–∞–∂—ñ—Ç—å IP-–∞–¥—Ä–µ—Å—É –≤–∞—à–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞
        const WEBSOCKET_URL = "ws://192.168.0.103:8000"; 
        
        let ws;
        try {
            if (window.location.protocol === "https:") {
                ws = new WebSocket(`${WEBSOCKET_URL.replace("ws://", "wss://")}/ws/${userId}/false`);
            } else {
                ws = new WebSocket(`${WEBSOCKET_URL}/ws/${userId}/false`);
            }
        } catch (error) {
            loader.textContent = "–ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ —Å–µ—Ä–≤–µ—Ä–∞.";
        }
        
        ws.onopen = function() {
            // –ó–∞–ø–∏—Ç—É—î–º–æ —É —Å–µ—Ä–≤–µ—Ä–∞, —á–∏ —Ü–µ –Ω–æ–≤–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á
            ws.send(JSON.stringify({ action: 'check_user_chat' }));
        };

        ws.onmessage = function(event) {
            const response = JSON.parse(event.data);

            if (response.type === 'user_status') {
                if (response.exists) {
                    // –Ø–∫—â–æ —á–∞—Ç —ñ—Å–Ω—É—î, –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –Ω–∞ chat.html
                    window.location.href = `chat.html?user_id=${userId}&lang=${userLang}`;
                } else {
                    // –Ø–∫—â–æ —á–∞—Ç –Ω–æ–≤–∏–π, –ø–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É "–ü–æ—á–∞—Ç–∏ —á–∞—Ç"
                    loader.style.display = 'none';
                    welcomeScreen.style.display = 'block';
                }
            }
        };

        ws.onerror = function() {
            loader.textContent = "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.";
        };

        startChatBtn.onclick = function() {
            // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —Å–µ—Ä–≤–µ—Ä, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø–æ—á–∞–≤ –Ω–æ–≤–∏–π —á–∞—Ç
            ws.send(JSON.stringify({ action: 'start_new_chat' }));
            // –Ü –æ–¥—Ä–∞–∑—É –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—î–º–æ –π–æ–≥–æ
            window.location.href = `chat.html?user_id=${userId}&lang=${userLang}`;
        };

    </script>
</body>
</html>
